#!/bin/bash

set -euo pipefail

PROJECT_DIR=$(dirname "$(realpath "$0")")
USER_ID=$(id -u "${USER}")
GROUP_ID=$(id -g "${USER}")

prepare_docker() {
    # Build the docker image
    cd "$PROJECT_DIR/docker"
    docker build -t easyaccept .
    cd "$PROJECT_DIR"
}

prepare_grammar() {
    mkdir -p "$PROJECT_DIR/.tmp/grammar/target"
    cp "$PROJECT_DIR/EasyScript.g4" "$PROJECT_DIR/.tmp/grammar/"
}

java() {
    # Run the 'javac' command
    docker run --rm -it -u "$USER_ID:$GROUP_ID" -v "$PROJECT_DIR:/work" --entrypoint="java" easyaccept "$@"
}

javac() {
    # Run the 'javac' command
    docker run --rm -it -u "$USER_ID:$GROUP_ID" -v "$PROJECT_DIR:/work" --entrypoint="javac" easyaccept "$@"
}

antlr4() {
    # Run the 'antlr4' command
    java -Xmx500M -cp /usr/local/lib/antlr4-tool.jar org.antlr.v4.Tool "$@"
}

antlr4_parse() {
    # Run the 'antlr4-parse' command
    java -cp /usr/local/lib/antlr4-tool.jar:.tmp/grammar/target/ org.antlr.v4.gui.TestRig "$@"
}

parse_arguments() {
    local help_requested=0
    local command_requested=""

    while [[ -z "$command_requested" && "$#" -gt 0 ]]; do
        case $1 in
            -h|--help)
                help_requested=1
                shift
                ;;
            *)
                command_requested=$1
                shift
                break
                ;;
        esac
    done

    if [[ $help_requested -eq 1 ]]; then
        case $command_requested in
            generate)
                echo "Usage: ./easy generate <language> [-o | --output <output_directory>] [-p | --package <package_name>]"
                echo
                echo "Generate the grammar on specified language. Supported languages: csharp"
                echo "Can specify output directory with -o or --output option."
                echo "Can specify library package name with -p or --package option."
                ;;
            tree)
                echo "Usage: ./easy tree"
                echo
                echo "Parse the grammar and print the parse tree."
                ;;
            *)
                echo "Usage: ./easy [-h | --help] <command> [<args>]"
                echo
                echo "Commands:"
                echo "  generate   Generate the grammar on specified language"
                echo "  tree       Parse the grammar and print the parse tree"
                ;;
        esac

        exit
    fi

    if [[ -z "$command_requested" ]]; then
        echo "Error: No command provided."
        echo "Use -h or --help for usage information."
        exit 1
    fi

    case $command_requested in
        generate)
            if [[ "$#" -lt 1 ]]; then
                echo "Error: No language provided for 'generate' command."
                echo "Use -h or --help for usage information."
                exit 1
            fi

            local language=$1
            shift

            local output_directory=""
            local package_name=""

            while [[ "$#" -gt 0 ]]; do
                case $1 in
                    -o|--output)
                        if [[ "$#" -lt 2 ]]; then
                            echo "Error: No output directory provided after '$1'."
                            echo "Use -h or --help for usage information."
                            exit 1
                        fi
                        output_directory=$2
                        shift 2
                        ;;
                    -p|--package)
                        if [[ "$#" -lt 2 ]]; then
                            echo "Error: No package name provided after '$1'."
                            echo "Use -h or --help for usage information."
                            exit 1
                        fi
                        package_name=$2
                        shift 2
                        ;;
                    *)
                        echo "Error: Unknown option '$1' for 'generate' command."
                        echo "Use -h or --help for usage information."
                        exit 1
                        ;;
                esac
            done

            if [[ "$language" == "csharp" ]]; then
                prepare_docker
                prepare_grammar

                # Generate the grammar as C# files
                if [[ -n "$package_name" ]]; then
                    antlr4 -Dlanguage=CSharp -package "$package_name" -o .tmp/grammar/csharp /work/EasyScript.g4
                else
                    antlr4 -Dlanguage=CSharp -o .tmp/grammar/csharp /work/EasyScript.g4
                fi

                # Move generated files to output directory if specified
                if [[ -n "$output_directory" ]]; then
                    mv .tmp/grammar/csharp "$output_directory"
                    echo "C# grammar files have been generated in '""$output_directory""'."
                else
                    echo "C# grammar files have been generated in '.tmp/grammar/csharp'."
                fi

                exit 0
            else
                echo "Error: Unsupported language '$language' for 'generate' command."
                echo "Use -h or --help for usage information."
                exit 1
            fi
            ;;
        tree)
            prepare_docker
            prepare_grammar

            # Generate the grammar as Java files
            antlr4 -Dlanguage=Java .tmp/grammar/EasyScript.g4

            # Compile the grammar
            JAVA_FILES=$(find "$PROJECT_DIR"/.tmp/grammar -name "*.java" -print0 | tr '\0' ' ')
            JAVA_FILES=${JAVA_FILES//"$PROJECT_DIR"\//}
            javac -cp /usr/local/lib/antlr4-tool.jar -d .tmp/grammar/target $JAVA_FILES

            # Run the 'antlr4-parse' command
            echo "Write your input and press Ctrl+D to finish."
            antlr4_parse EasyScript easy -tree

            exit 0
            ;;
        *)
            echo "Error: Unknown command '$command_requested'."
            echo "Use -h or --help for usage information."
            exit 1
            ;;
    esac
}

# Prepare temporary directory
mkdir -p "$PROJECT_DIR/.tmp"

parse_arguments "$@"
